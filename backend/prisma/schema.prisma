generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  HOMEOWNER
  COMPANY
  CITY
}

enum QuoteStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  DELAYED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  OVERDUE
}

enum PostType {
  MATERIAL
  SERVICE
  SPACE
}

enum PostStatus {
  AVAILABLE
  RESERVED
  SOLD
  DELETED
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

model User {
  id        String              @id @default(cuid())
  email     String              @unique
  password  String
  name      String?
  role      Role                @default(HOMEOWNER)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  // relations
  contractorProfile ContractorProfile?
  companyProfile    CompanyProfile?
  cityProfile       CityProfile?
  projects          Project[]           @relation("HomeownerProjects")
  posts             Post[]
  offers            Offer[]             @relation("UserOffers")
  refreshToken      RefreshToken[]
}

model ContractorProfile {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @unique
  companyName String
  description String?
  services    String   // JSON string of services array
  logoUrl     String?
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // relations
  quotes      Quote[]
}

model Project {
  id          String   @id @default(cuid())
  homeowner   User     @relation("HomeownerProjects", fields: [homeownerId], references: [id])
  homeownerId String
  title       String
  description String?
  projectType String
  size        Float?   // m²
  materials   String?  // materials preference
  budgetMin   Int?
  budgetMax   Int?
  predictedCost Int?   // from cost calculator
  status      String   @default("OPEN") // OPEN, IN_PROGRESS, COMPLETED, CANCELLED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // relations
  quotes      Quote[]
  milestones  Milestone[]
}

model Quote {
  id             String      @id @default(cuid())
  project        Project     @relation(fields: [projectId], references: [id])
  projectId      String
  contractor     ContractorProfile @relation(fields: [contractorId], references: [id])
  contractorId   String
  
  totalAmount    Int         // total quote amount
  laborHours     Float?
  laborCost      Int?
  materialsCost  Int?
  extrasCost     Int?
  notes          String?
  
  status         QuoteStatus @default(PENDING)
  validUntil     DateTime?   // quote expiry
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // relations
  lineItems      QuoteLineItem[]
  
  @@unique([projectId, contractorId]) // one quote per contractor per project
}

model QuoteLineItem {
  id          String @id @default(cuid())
  quote       Quote  @relation(fields: [quoteId], references: [id])
  quoteId     String
  
  category    String // "Labor", "Materials", "Equipment", etc.
  description String
  quantity    Float
  unitPrice   Int    // in cents
  totalPrice  Int    // quantity * unitPrice
  
  createdAt   DateTime @default(now())
}

model Milestone {
  id          String          @id @default(cuid())
  project     Project         @relation(fields: [projectId], references: [id])
  projectId   String
  
  title       String
  description String?
  order       Int             // milestone sequence
  status      MilestoneStatus @default(PENDING)
  
  scheduledDate DateTime?
  completedDate DateTime?
  
  // payment related
  paymentAmount Int?
  paymentStatus PaymentStatus @default(PENDING)
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime @default(now())
}

model CompanyProfile {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @unique
  companyName String
  description String?
  logoUrl     String?
  verified    Boolean  @default(false)
  latitude    Float?
  longitude   Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // relations
  posts       Post[]
  offers      Offer[]  @relation("CompanyOffers")
}

model CityProfile {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @unique
  cityName    String
  description String?
  logoUrl     String?
  verified    Boolean  @default(false)
  latitude    Float?
  longitude   Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // relations
  posts       Post[]
}

model Post {
  id            String      @id @default(cuid())
  type          PostType
  status        PostStatus  @default(AVAILABLE)
  
  // Who posted it
  user          User        @relation(fields: [userId], references: [id])
  userId        String
  company       CompanyProfile? @relation(fields: [companyId], references: [id])
  companyId     String?
  city          CityProfile? @relation(fields: [cityId], references: [id])
  cityId        String?

  // Basic info
  title         String
  description   String?
  images        Json?       // array of image URLs
  
  // Subtype (e.g., "window", "tiles", "transport", "coworking")
  subtype       String
  
  // Quantity and pricing
  quantity      Float?
  unit          String?     // m², m³, pieces, liters, kilograms
  price         Int?        // price in cents
  
  // Location (required for map)
  latitude      Float
  longitude     Float
  address       String?
  
  // Availability and condition
  availabilityDate DateTime?
  condition     String?     // new/used/damaged
  rentalDuration String?    // for spaces
  
  // Service/Rental specific
  hourlyRate    Int?        // for services/rentals
  dailyRate     Int?        // for services/rentals
  
  // Additional options
  pickupAllowed Boolean     @default(false)
  transportNeeded Boolean   @default(false)
  canCompanyCollect Boolean @default(false)
  permitForReuse Boolean    @default(false)
  hazardousMaterials Boolean @default(false)
  structuralItems Boolean   @default(false)
  
  // Social
  socialLink    String?     // Instagram/share link
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // relations
  offers        Offer[]
  auditLogs     PostAuditLog[]

  @@index([latitude, longitude])
  @@index([type, status])
  @@index([userId])
}

model Offer {
  id          String      @id @default(cuid())
  post        Post        @relation(fields: [postId], references: [id])
  postId     String
  
  // Who made the offer
  user        User        @relation("UserOffers", fields: [userId], references: [id])
  userId      String
  company     CompanyProfile? @relation("CompanyOffers", fields: [companyId], references: [id])
  companyId   String?
  
  amount      Int?        // offer amount in cents
  message     String?
  status      OfferStatus @default(PENDING)
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model PostAuditLog {
  id          String   @id @default(cuid())
  post        Post     @relation(fields: [postId], references: [id])
  postId      String
  
  userId      String   // who made the change
  action      String   // "CREATE", "UPDATE", "DELETE", "STATUS_CHANGE"
  fieldName   String?  // which field was changed
  oldValue    String?  // old value (JSON stringified if complex)
  newValue    String?  // new value (JSON stringified if complex)
  
  createdAt   DateTime @default(now())
  
  @@index([postId])
  @@index([userId])
}